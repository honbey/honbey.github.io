<!DOCTYPE html>
<html lang="en">
<head>
<!-- 2022-08-31 Wed 18:52 -->
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Nginx</title>
<meta name="author" content="Honbey Zhang" />
<meta name="generator" content="Org Mode" />
<link rel="stylesheet" href="../resources/orgmode.css" type="text/css"/>
                     <link rel="stylesheet" href="../resources/style.css" type="text/css"/>
</head>
<body>
<div id="content" class="content">
<header>
<h1 class="title">Nginx</h1>
</header>
<div id="outline-container-org275522f" class="outline-2">
<h2 id="org275522f">Nginx</h2>
<div class="outline-text-2" id="text-org275522f">
<ul class="org-ul">
<li><a href="#org8600d7c">Directives</a></li>
<li><a href="#org34373cf">Variables</a></li>
</ul>
</div>
</div>

<div id="outline-container-org8600d7c" class="outline-2">
<h2 id="org8600d7c">Directives</h2>
<div class="outline-text-2" id="text-org8600d7c">
</div>
<div id="outline-container-org7e6771b" class="outline-3">
<h3 id="org7e6771b">sendfile</h3>
<div class="outline-text-3" id="text-org7e6771b">
<p>
默认 off ，配置是否由 Linux 内核直接读取文件（ <a href="20220724-linux.html#ID-a22d50a1-2a30-499c-b6f7-25d65e2016e3">System Call</a> ），而不是通过 read, write 来操作。
</p>
</div>
</div>
<div id="outline-container-org8d2be28" class="outline-3">
<h3 id="org8d2be28">tcp_nopush</h3>
<div class="outline-text-3" id="text-org8d2be28">
<p>
默认 off ，配置是否开启 socket 的 <a href="20220718-socket.html#ID-8d1430e6-40a0-4ec5-92bf-53c3c8d5864f"><code>TCP_CORK</code></a> 选项。
</p>
</div>
</div>
<div id="outline-container-org9c2ae70" class="outline-3">
<h3 id="org9c2ae70">tcp_nodelay</h3>
<div class="outline-text-3" id="text-org9c2ae70">
<p>
默认 on ，配置是否关闭 nagle 算法，即 <a href="20220718-socket.html#ID-8f561f8b-dcb8-412d-89fe-bb5d51641fc9"><code>TCP_NODELAY</code></a> 选项。
</p>
</div>
</div>
<div id="outline-container-org9da857e" class="outline-3">
<h3 id="org9da857e">access_<a href="20220802-log.html#ID-b69b104b-4d85-475e-a73c-1726bf511048">log</a></h3>
<div class="outline-text-3" id="text-org9da857e">
<div class="org-src-container">
<pre class="src src-nginx">log_format combined '$remote_addr - $remote_user [$time_local] "$request" '
                    '$status $body_bytes_sent "$http_referer" '
                    '"$http_user_agent" "$http_x_forwarded_for"';
access_log logs/access.log combined;
</pre>
</div>
<p>
使用 JSON 格式：
</p>
<div class="org-src-container">
<pre class="src src-nginx">log_format json_analytics escape=json '{'
    '"msec": "$msec", '                                         # request unixtime in seconds with a milliseconds resolution
    '"connection": "$connection", '                             # connection serial number
    '"connection_requests": "$connection_requests", '           # number of requests made in connection
    '"pid": "$pid", '                                           # process pid
    '"request_id": "$request_id", '                             # the unique request id
    '"request_length": "$request_length", '                     # request length (including headers and body)
    '"remote_addr": "$remote_addr", '                           # client IP
    '"remote_user": "$remote_user", '                           # client HTTP username
    '"remote_port": "$remote_port", '                           # client port
    '"time_local": "$time_local", '
    '"time_iso8601": "$time_iso8601", '                         # local time in the ISO 8601 standard format
    '"request": "$request", '                                   # full path no arguments if the request
    '"request_uri": "$request_uri", '                           # full path and arguments if the request
    '"args": "$args", '
    '"status": "$status", '                                     # response status code
    '"body_bytes_sent": "$body_bytes_sent", '                   # the number of body bytes exclude headers sent to a client
    '"bytes_sent": "$bytes_sent", '                             # the number of bytes sent to a client
    '"referer": "$http_referer", '
    '"user_agent": "$http_user_agent", '
    '"x_forwarded_for": "$http_x_forwarded_for", '              # http_x_forwarded_for
    '"host": "$http_host", '                                    # the request Host: header
    '"server_name": "$server_name", '                           # the name of the vhost serving the request
    '"request_time": "$request_time", '                         # request processing time in seconds with msec resolution
    '"upstream": "$upstream_addr", '                            # upstream backend server for proxied requests
    '"upstream_connect_time": "$upstream_connect_time", '       # upstream handshake time incl. TLS
    '"upstream_header_time": "$upstream_header_time", '         # time spent receiving upstream headers
    '"upstream_response_time": "$upstream_response_time", '     # time spend receiving upstream body
    '"upstream_response_length": "$upstream_response_length", ' # upstream response length
    '"upstream_cache_status": "$upstream_cache_status", '       # cache HIT/MISS where applicable
    '"ssl_protocol": "$ssl_protocol", '                         # TLS protocol
    '"ssl_cipher": "$ssl_cipher", '                             # TLS cipher
    '"scheme": "$scheme", '                                     # http or https
    '"request_method": "$request_method", '                     # request method
    '"server_protocol": "$server_protocol", '                   # request protocol, like HTTP/1.1 or HTTP/2.0
    '"geoip_country_code": "$geoip_country_code", '
    '"geoip_city": "$geoip_city"'
'}';

access_log     /var/data/log/nginx/json_access.log json_analytics buffer=4k flush=60 if=$logable;
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org34373cf" class="outline-2">
<h2 id="org34373cf">Variables</h2>
<div class="outline-text-2" id="text-org34373cf">
</div>
<div id="outline-container-org14ea3fe" class="outline-3">
<h3 id="org14ea3fe">upstream_response_length</h3>
<div class="outline-text-3" id="text-org14ea3fe">
<blockquote>
<p>
$upstream_response_length
keeps the length of the response obtained from the upstream server (0.7.27); the length is kept in bytes. Lengths of several responses are separated by commas and colons like addresses in the $upstream_addr variable.
</p>
</blockquote>
<p>
<code>upstream_response_length</code> 在配置了 <code>error_page</code> 等内部重定向时为 0。
</p>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">
<a href="https://beian.miit.gov.cn" target="_blank">湘ICP证019014083号</a>
</div>
</body>
</html>
