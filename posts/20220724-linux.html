<!DOCTYPE html>
<html lang="en">
<head>
<!-- 2022-11-21 Mon 22:08 -->
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Linux</title>
<meta name="author" content="Honbey Zhang" />
<meta name="generator" content="Org Mode" />
<link rel="stylesheet" href="../resources/orgmode.css" type="text/css"/>
                     <link rel="stylesheet" href="../resources/style.css" type="text/css"/>
</head>
<body>
<div id="content" class="content">
<header>
<h1 class="title">Linux</h1>
</header>
<div id="outline-container-ID-a22d50a1-2a30-499c-b6f7-25d65e2016e3" class="outline-2">
<h2 id="ID-a22d50a1-2a30-499c-b6f7-25d65e2016e3">Architecture</h2>
<div class="outline-text-2" id="text-ID-a22d50a1-2a30-499c-b6f7-25d65e2016e3">
<pre class="example">
   Application
Shell | Lib Function
   System Call
   Kernel
</pre>
</div>
</div>

<div id="outline-container-ID-3cedef2b-ff4a-492e-a8e0-7a1a4779a407" class="outline-2">
<h2 id="ID-3cedef2b-ff4a-492e-a8e0-7a1a4779a407">I/O</h2>
<div class="outline-text-2" id="text-ID-3cedef2b-ff4a-492e-a8e0-7a1a4779a407">
<p>
传统 I/O （缓存 I/O）：硬盘 -&gt; 内核缓冲区 -&gt; 用户缓冲区 -&gt; 内核 socket 缓冲区 -&gt; 协议引擎
</p>

<p>
sendfile: 硬盘 -&gt; 内核缓冲区 -&gt; 内核 socket 缓冲区 -&gt; 协议引擎
</p>

<p>
sendfile（<a href="20220708-hardware.html#ID-3bc17eaf-8d5c-48d4-8efa-58f9429b2794">DMA</a> 收集拷贝）：硬盘 -&gt; 内核缓冲区 -&gt; 协议引擎
</p>
</div>

<div id="outline-container-org504402e" class="outline-3">
<h3 id="org504402e">零拷贝技术 - sendfile</h3>
<div class="outline-text-3" id="text-org504402e">
<div class="org-src-container">
<pre class="src src-c"><span style="color: #808080;">#include</span> <span style="color: #008000;">&lt;sys/sendfile.h&gt;</span>
<span style="color: #006FE0;">ssize_t</span> <span style="color: #006699;">snedfile</span><span style="color: #707183; background-color: #FFFFFF;">(</span><span style="color: #006FE0;">int</span> <span style="color: #BA36A5;">out_fd</span><span style="color: #333333; background-color: #FFFFFF;">,</span> <span style="color: #006FE0;">int</span> <span style="color: #BA36A5;">in_fd</span><span style="color: #333333; background-color: #FFFFFF;">,</span> <span style="color: #6434A3;">off_t</span><span style="color: #0000FF;">*</span> <span style="color: #BA36A5;">offset</span><span style="color: #333333; background-color: #FFFFFF;">,</span> <span style="color: #006FE0;">size_t</span> <span style="color: #BA36A5;">count</span><span style="color: #707183; background-color: #FFFFFF;">)</span><span style="color: #333333; background-color: #FFFFFF;">;</span>
</pre>
</div>

<p>
sendfile 函数是在两个文件描述符中直接传递数据（完全在内核中操作），从而避免了用户缓冲区和内核缓冲区之间的数据拷贝，操作效率很高。
</p>
</div>
</div>
</div>
<div id="outline-container-orgfb0639e" class="outline-2">
<h2 id="orgfb0639e">Process</h2>
<div class="outline-text-2" id="text-orgfb0639e">
<ul class="org-ul">
<li><a href="20220912-linux_fork.html#ID-fe4f5bde-dd07-4119-a55e-d994e263146b">Linux <code>fork()</code></a></li>
</ul>
</div>
</div>

<div id="outline-container-orgda5259c" class="outline-2">
<h2 id="orgda5259c">Useful Command</h2>
<div class="outline-text-2" id="text-orgda5259c">
</div>
<div id="outline-container-org9bf3a75" class="outline-3">
<h3 id="org9bf3a75">Let non-root/normal user use port which less then 1024</h3>
<div class="outline-text-3" id="text-org9bf3a75">
<div class="org-src-container">
<pre class="src src-bash"><span style="color: #006DAF;">setcap</span> cap_net_bind_service=+eip /path/executable_program
</pre>
</div>
</div>
</div>

<div id="outline-container-ID-30464b22-0321-4bd8-846f-7d2ee1b1af4c" class="outline-3">
<h3 id="ID-30464b22-0321-4bd8-846f-7d2ee1b1af4c">Recover files on Linux</h3>
<div class="outline-text-3" id="text-ID-30464b22-0321-4bd8-846f-7d2ee1b1af4c">
<div class="org-src-container">
<pre class="src src-bash"><span style="color: #8D8D84; font-style: italic;"># backup sector</span>
<span style="color: #006DAF;">dd</span> if=/path/filename of=/dev/vda1
<span style="color: #8D8D84; font-style: italic;"># unmount</span>
<span style="color: #006DAF;">umount</span> /dev/vda1
<span style="color: #8D8D84; font-style: italic;"># force unmount</span>
<span style="color: #006DAF;">fuser</span> <span style="color: #D0372D;">-m</span> <span style="color: #D0372D;">-v</span> <span style="color: #D0372D;">-i</span> <span style="color: #D0372D;">-k</span> /dev/vda1
<span style="color: #8D8D84; font-style: italic;"># scan</span>
<span style="color: #006DAF;">extundelete</span> <span style="color: #D0372D;">--inode</span> <span style="color: #D0372D;">2</span> /dev/vda1
<span style="color: #8D8D84; font-style: italic;"># recover</span>
<span style="color: #006DAF;">extundelete</span> /dev/vda1 <span style="color: #D0372D;">--restore-all</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org5ec11b4" class="outline-3">
<h3 id="org5ec11b4">Safe rm</h3>
<div class="outline-text-3" id="text-org5ec11b4">
<div class="org-src-container">
<pre class="src src-bash"><span style="color: #8D8D84; font-style: italic;">#!/usr/bin/env bash</span>
<span style="color: #BA36A5; font-style: italic;">args</span>=<span style="color: #008000;">""</span>

<span style="color: #0000FF;">while</span> <span style="color: #006FE0;">getopts</span> <span style="color: #008000;">':rRfiIdv'</span> OPTION<span style="color: #0000FF;">;</span> <span style="color: #0000FF;">do</span>
    <span style="color: #0000FF;">case</span> <span style="color: #BA36A5;">"</span><span style="color: #D0372D;">$</span><span style="color: #BA36A5; font-style: italic;">OPTION</span><span style="color: #BA36A5;">"</span> <span style="color: #0000FF;">in</span>
        <span style="color: #D0372D;">r</span><span style="color: #0000FF;">|</span><span style="color: #D0372D;">R</span><span style="color: #0000FF;">|</span><span style="color: #D0372D;">\?</span>)
            <span style="color: #0000FF;">;;</span>

        <span style="color: #D0372D;">*</span>)
            <span style="color: #BA36A5; font-style: italic;">args</span>=<span style="color: #008000;">"</span><span style="color: #D0372D;">$</span><span style="color: #BA36A5; font-style: italic;">args</span><span style="color: #0000FF;">$</span><span style="color: #D0372D; font-style: italic;">OPTION</span><span style="color: #008000;">"</span>
            <span style="color: #0000FF;">;;</span>
    <span style="color: #0000FF;">esac</span>
<span style="color: #0000FF;">done</span>

<span style="color: #006FE0;">shift</span> <span style="color: #008000;">"</span><span style="color: #FF1493;">$(</span><span style="color: #FF1493; background-color: #FFFFFF;">(</span><span style="color: #FF1493; background-color: #FFFFFF;">$</span><span style="color: #FF1493; background-color: #FFFFFF; font-style: italic;">OPTIND</span><span style="color: #FF1493; background-color: #FFFFFF;"> </span><span style="color: #FF1493; background-color: #FFFFFF;">-</span><span style="color: #FF1493; background-color: #FFFFFF;"> 1)</span><span style="color: #008000;">)</span><span style="color: #008000;">"</span>

<span style="color: #0000FF;">if</span> <span style="color: #707183;">[</span><span style="color: #7388D6;">[</span> -n <span style="color: #008000;">"</span><span style="color: #D0372D;">$</span><span style="color: #BA36A5; font-style: italic;">args</span><span style="color: #008000;">"</span> <span style="color: #7388D6;">]</span><span style="color: #707183;">]</span><span style="color: #0000FF;">;</span> <span style="color: #0000FF;">then</span>
    <span style="color: #006DAF;">mv</span> <span style="color: #008000;">"-</span><span style="color: #D0372D;">$</span><span style="color: #BA36A5; font-style: italic;">args</span><span style="color: #008000;">"</span> <span style="color: #008000;">"</span><span style="color: #D0372D;">$</span><span style="color: #BA36A5; font-weight: bold;">@</span><span style="color: #008000;">"</span> /opt/data/.trash
<span style="color: #0000FF;">else</span>
    <span style="color: #006DAF;">mv</span> <span style="color: #008000;">"</span><span style="color: #D0372D;">$</span><span style="color: #BA36A5; font-weight: bold;">@</span><span style="color: #008000;">"</span> /opt/data/.trash
<span style="color: #0000FF;">fi</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-orgafdd30c" class="outline-3">
<h3 id="orgafdd30c">Read file</h3>
<div class="outline-text-3" id="text-orgafdd30c">
<div class="org-src-container">
<pre class="src src-bash"><span style="color: #8D8D84; font-style: italic;">#!/usr/bin/env bash</span>

<span style="color: #8D8D84; font-style: italic;"># This is correct way to read file.</span>
<span style="color: #BA36A5; font-style: italic;">FILE</span>=<span style="color: #008000;">"./tmp/use.py"</span>
<span style="color: #BA36A5; font-style: italic;">k</span>=<span style="color: #D0372D;">1</span>

<span style="color: #0000FF;">while</span> <span style="color: #006FE0;">read</span> <span style="color: #D0372D;">-r</span> line<span style="color: #0000FF;">;</span> <span style="color: #0000FF;">do</span>
    <span style="color: #006FE0;">echo</span> <span style="color: #008000;">"</span><span style="color: #D0372D;">$</span><span style="color: #BA36A5; font-style: italic;">line</span><span style="color: #008000;">"</span>
    <span style="color: #707183;">(</span><span style="color: #7388D6;">(</span>k++<span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
<span style="color: #0000FF;">done</span> <span style="color: #0000FF;">&lt;</span> <span style="color: #008000;">"</span><span style="color: #D0372D;">$</span><span style="color: #BA36A5; font-style: italic;">FILE</span><span style="color: #008000;">"</span>

<span style="color: #006FE0;">echo</span> <span style="color: #008000;">"Total number of lines in file: </span><span style="color: #D0372D;">$</span><span style="color: #BA36A5; font-style: italic;">k</span><span style="color: #008000;">"</span>
</pre>
</div>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">
<a href="https://beian.miit.gov.cn" target="_blank">湘ICP证019014083号</a>
</div>
</body>
</html>
