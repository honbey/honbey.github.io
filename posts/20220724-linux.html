<!DOCTYPE html>
<html lang="en">
<head>
<!-- 2023-02-02 Thu 21:55 -->
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Linux</title>
<meta name="author" content="Honbey Zhang" />
<meta name="generator" content="Org Mode" />

                     <!--
                     <link rel="stylesheet" href="../resources/orgmode.css" type="text/css"/>
                     <link rel="stylesheet" href="../resources/style.css" type="text/css"/>
                     -->
                     <!--
                     <link rel="stylesheet" href="../resources/src/bigblow_theme/css/htmlize.css" type="text/css"/>
                     <link rel="stylesheet" href="../resources/src/bigblow_theme/css/bigblow.css" type="text/css"/>
                     <link rel="stylesheet" href="../resources/src/bigblow_theme/css/hideshow.css" type="text/css"/>
                     <script type="text/javascript" src="../resources/src/bigblow_theme/js/jquery-1.11.0.min.js"></script>
                     <script type="text/javascript" src="../resources/src/bigblow_theme/js/jquery-ui-1.10.2.min.js"></script>
                     <script type="text/javascript" src="../resources/src/bigblow_theme/js/jquery.localscroll-min.js"></script>
                     <script type="text/javascript" src="../resources/src/bigblow_theme/js/jquery.scrollTo-1.4.3.1-min.js"></script>
                     <script type="text/javascript" src="../resources/src/bigblow_theme/js/jquery.zclip.min.js"></script>
                     <script type="text/javascript" src="../resources/src/bigblow_theme/js/bigblow.js"></script>
                     <script type="text/javascript" src="../resources/src/bigblow_theme/js/hideshow.js"></script>
                     <script type="text/javascript" src="../resources/src/lib/js/jquery.stickytableheaders.min.js"></script>
                     -->
                     <link rel="stylesheet" href="../resources/src/readtheorg_theme/css/htmlize.css" type="text/css"/>
                     <link rel="stylesheet" href="../resources/src/readtheorg_theme/css/readtheorg.css" type="text/css"/>
                     <script type="text/javascript" src="../resources/src/lib/js/jquery.min.js"></script>
                     <script type="text/javascript" src="../resources/src/lib/js/bootstrap.min.js"></script>
                     <script type="text/javascript" src="../resources/src/lib/js/jquery.stickytableheaders.min.js"></script>
                     <script type="text/javascript" src="../resources/src/readtheorg_theme/js/readtheorg.js"></script>
</head>
<body>
<div id="content" class="content">
<header>
<h1 class="title">Linux</h1>
</header><nav id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#ID-a22d50a1-2a30-499c-b6f7-25d65e2016e3">Architecture</a></li>
<li><a href="#ID-3cedef2b-ff4a-492e-a8e0-7a1a4779a407">I/O</a>
<ul>
<li><a href="#org504402e">零拷贝技术 - sendfile</a></li>
</ul>
</li>
<li><a href="#orgfb0639e">Process</a></li>
<li><a href="#orgda5259c">Useful Command</a>
<ul>
<li><a href="#org9bf3a75">Let non-root/normal user use port which less then 1024</a></li>
<li><a href="#ID-30464b22-0321-4bd8-846f-7d2ee1b1af4c">Recover files on Linux</a></li>
<li><a href="#org5ec11b4">Safe rm</a></li>
<li><a href="#orgafdd30c">Read file</a></li>
<li><a href="#orgd38cc16">utils tools</a></li>
<li><a href="#orgf60f30d">Set timezone</a></li>
<li><a href="#orgbdc50af">git completely remove files</a></li>
</ul>
</li>
</ul>
</div>
</nav>

<div id="outline-container-ID-a22d50a1-2a30-499c-b6f7-25d65e2016e3" class="outline-2">
<h2 id="ID-a22d50a1-2a30-499c-b6f7-25d65e2016e3">Architecture</h2>
<div class="outline-text-2" id="text-ID-a22d50a1-2a30-499c-b6f7-25d65e2016e3">
<pre class="example">
   Application
Shell | Lib Function
   System Call
   Kernel
</pre>
</div>
</div>

<div id="outline-container-ID-3cedef2b-ff4a-492e-a8e0-7a1a4779a407" class="outline-2">
<h2 id="ID-3cedef2b-ff4a-492e-a8e0-7a1a4779a407">I/O</h2>
<div class="outline-text-2" id="text-ID-3cedef2b-ff4a-492e-a8e0-7a1a4779a407">
<p>
传统 I/O （缓存 I/O）：硬盘 -&gt; 内核缓冲区 -&gt; 用户缓冲区 -&gt; 内核 socket 缓冲区 -&gt; 协议引擎
</p>

<p>
sendfile: 硬盘 -&gt; 内核缓冲区 -&gt; 内核 socket 缓冲区 -&gt; 协议引擎
</p>

<p>
sendfile（<a href="20220708-hardware.html#ID-3bc17eaf-8d5c-48d4-8efa-58f9429b2794">DMA</a> 收集拷贝）：硬盘 -&gt; 内核缓冲区 -&gt; 协议引擎
</p>
</div>

<div id="outline-container-org504402e" class="outline-3">
<h3 id="org504402e">零拷贝技术 - sendfile</h3>
<div class="outline-text-3" id="text-org504402e">
<div class="org-src-container">
<pre class="src src-c">#include &lt;sys/sendfile.h&gt;
ssize_t snedfile(int out_fd, int in_fd, off_t* offset, size_t count);
</pre>
</div>

<p>
sendfile 函数是在两个文件描述符中直接传递数据（完全在内核中操作），从而避免了用户缓冲区和内核缓冲区之间的数据拷贝，操作效率很高。
</p>
</div>
</div>
</div>
<div id="outline-container-orgfb0639e" class="outline-2">
<h2 id="orgfb0639e">Process</h2>
<div class="outline-text-2" id="text-orgfb0639e">
<ul class="org-ul">
<li><a href="20220912-linux_fork.html#ID-fe4f5bde-dd07-4119-a55e-d994e263146b">Linux <code>fork()</code></a></li>
</ul>
</div>
</div>

<div id="outline-container-orgda5259c" class="outline-2">
<h2 id="orgda5259c">Useful Command</h2>
<div class="outline-text-2" id="text-orgda5259c">
</div>
<div id="outline-container-org9bf3a75" class="outline-3">
<h3 id="org9bf3a75">Let non-root/normal user use port which less then 1024</h3>
<div class="outline-text-3" id="text-org9bf3a75">
<div class="org-src-container">
<pre class="src src-bash">setcap cap_net_bind_service=+eip /path/executable_program
</pre>
</div>
</div>
</div>

<div id="outline-container-ID-30464b22-0321-4bd8-846f-7d2ee1b1af4c" class="outline-3">
<h3 id="ID-30464b22-0321-4bd8-846f-7d2ee1b1af4c">Recover files on Linux</h3>
<div class="outline-text-3" id="text-ID-30464b22-0321-4bd8-846f-7d2ee1b1af4c">
<div class="org-src-container">
<pre class="src src-bash"># backup sector
dd if=/path/filename of=/dev/vda1
# unmount
umount /dev/vda1
# force unmount
fuser -m -v -i -k /dev/vda1
# scan
extundelete --inode 2 /dev/vda1
# recover
extundelete /dev/vda1 --restore-all
</pre>
</div>
</div>
</div>

<div id="outline-container-org5ec11b4" class="outline-3">
<h3 id="org5ec11b4">Safe rm</h3>
<div class="outline-text-3" id="text-org5ec11b4">
<div class="org-src-container">
<pre class="src src-bash">#!/usr/bin/env bash
args=""

while getopts ':rRfiIdv' OPTION; do
    case "$OPTION" in
        r|R|\?)
            ;;

        *)
            args="$args$OPTION"
            ;;
    esac
done

shift "$(($OPTIND - 1))"

if [[ -n "$args" ]]; then
    mv "-$args" "$@" /opt/data/.trash
else
    mv "$@" /opt/data/.trash
fi
</pre>
</div>
</div>
</div>
<div id="outline-container-orgafdd30c" class="outline-3">
<h3 id="orgafdd30c">Read file</h3>
<div class="outline-text-3" id="text-orgafdd30c">
<div class="org-src-container">
<pre class="src src-bash">#!/usr/bin/env bash

# This is correct way to read file.
FILE="./tmp/use.py"
k=1

while read -r line; do
    echo "$line"
    ((k++))
done &lt; "$FILE"

echo "Total number of lines in file: $k"
</pre>
</div>
</div>
</div>

<div id="outline-container-orgd38cc16" class="outline-3">
<h3 id="orgd38cc16">utils tools</h3>
<div class="outline-text-3" id="text-orgd38cc16">
<p>
Rust-alternatives <code>[3/7]</code>:
</p>
<ul class="org-ul">
<li class="off"><code>[&#xa0;]</code> ls -&gt; exa</li>
<li class="on"><code>[X]</code> grep -&gt; ripgrep</li>
<li class="on"><code>[X]</code> find -&gt; fd</li>
<li class="on"><code>[X]</code> less -&gt; bat</li>
<li class="off"><code>[&#xa0;]</code> ps -&gt; procs</li>
<li class="off"><code>[&#xa0;]</code> (count code) -&gt; tokei</li>
<li class="off"><code>[&#xa0;]</code> du -&gt; dust</li>
</ul>
</div>
</div>

<div id="outline-container-orgf60f30d" class="outline-3">
<h3 id="orgf60f30d">Set timezone</h3>
<div class="outline-text-3" id="text-orgf60f30d">
<div class="org-src-container">
<pre class="src src-bash">timedatectl list-timezones | grep Shanghai
sudo timedatectl set-timezone Asia/Shanghai
</pre>
</div>
</div>
</div>

<div id="outline-container-orgbdc50af" class="outline-3">
<h3 id="orgbdc50af">git completely remove files</h3>
<div class="outline-text-3" id="text-orgbdc50af">
<div class="org-src-container">
<pre class="src src-bash">git filter-branch --force --index-filter 'git rm -r --cached --ignore-unmatch &lt;files&gt;' --prune-empty --tag-name-filter cat -- --all
</pre>
</div>

<div class="org-src-container">
<pre class="src src-bash">git rm --cached -r .
git gc --prune

# repack
git for-each-ref --format='delete %(refname)' refs/original | git update-ref --stdin
git reflog expire --expire=now --all
git gc --prune=now
</pre>
</div>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">

                     Theme
                     <a href="https://github.com/fniessen/org-html-themes" target="_blank">bigblow/readtheorg</a>
                     by
                     <a href="https://github.com/fniessen" target="_blank">fniessen</a>
                     <br>
                     <a href="https://beian.miit.gov.cn" target="_blank">湘ICP证019014083号</a>
</div>
</body>
</html>