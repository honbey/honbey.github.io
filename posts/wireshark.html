<!DOCTYPE html>
<html lang="en">
<head>
<!-- 2022-09-08 Thu 20:11 -->
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Wireshark and tcpdump</title>
<meta name="author" content="Honbey Zhang" />
<meta name="generator" content="Org Mode" />
<link rel="stylesheet" href="../resources/orgmode.css" type="text/css"/>
                     <link rel="stylesheet" href="../resources/style.css" type="text/css"/>
</head>
<body>
<div id="content" class="content">
<header>
<h1 class="title">Wireshark and tcpdump</h1>
</header>
<div id="outline-container-ID-0cab26c8-3627-4e10-a7f9-535945a56511" class="outline-2">
<h2 id="ID-0cab26c8-3627-4e10-a7f9-535945a56511">Wireshark</h2>
<div class="outline-text-2" id="text-ID-0cab26c8-3627-4e10-a7f9-535945a56511">
<p>
封包？数据帧？报文？
</p>
<ul class="org-ul">
<li>封包列表
<ul class="org-ul">
<li>捕获时间</li>
<li>协议</li>
<li>源、目的地址</li>
</ul></li>
<li>封包详细信息</li>
</ul>

<p>
常见协议：<a href="20220708-network_protocol.html#ID-e1bacc12-32cc-41f9-931e-6e6489fd0a60">network_protocol</a>
</p>
</div>
</div>

<div id="outline-container-org1aee420" class="outline-2">
<h2 id="org1aee420">显示过滤器</h2>
<div class="outline-text-2" id="text-org1aee420">
<p>
针对已经捕获的报文进行过滤。 <b>一条基本的表达式由过滤项、过滤关系、过滤值组成</b> ，例如：
</p>
<pre class="example">
过滤项 关系 过滤值
ip.src == 192.168.1.1
协  协议     确定值
议  字段
</pre>
</div>

<div id="outline-container-orgaac18ba" class="outline-4">
<h4 id="orgaac18ba">过滤项</h4>
<div class="outline-text-4" id="text-orgaac18ba">
<ul class="org-ul">
<li>协议</li>
<li>协议字段</li>
</ul>
</div>
</div>
<div id="outline-container-org716380e" class="outline-4">
<h4 id="org716380e">常用字段</h4>
<div class="outline-text-4" id="text-org716380e">
<ul class="org-ul">
<li>address
<ul class="org-ul">
<li>源、目的 IP</li>
<li>源、目的 MAC</li>
<li>网段</li>
</ul></li>
<li>port
<ul class="org-ul">
<li>源、目的 IP</li>
</ul></li>
<li>length
<ul class="org-ul">
<li>报文长度</li>
</ul></li>
<li>contains
<ul class="org-ul">
<li>查询 payload 中的关键字</li>
</ul></li>
</ul>
</div>
</div>


<div id="outline-container-orgbf2c0f6" class="outline-3">
<h3 id="orgbf2c0f6">过滤关系</h3>
<div class="outline-text-3" id="text-orgbf2c0f6">
<ul class="org-ul">
<li>大于
<ul class="org-ul">
<li>gt</li>
<li>&gt;</li>
</ul></li>
<li>大于等于
<ul class="org-ul">
<li>ge</li>
<li>&gt;=</li>
</ul></li>
<li>小于
<ul class="org-ul">
<li>lt</li>
<li>&lt;</li>
</ul></li>
<li>小于等于
<ul class="org-ul">
<li>le</li>
<li>&lt;=</li>
</ul></li>
<li>等于
<ul class="org-ul">
<li>eq</li>
<li>==</li>
</ul></li>
<li>不等于
<ul class="org-ul">
<li>ne</li>
<li>!=</li>
</ul></li>
</ul>
</div>

<div id="outline-container-org35cf122" class="outline-4">
<h4 id="org35cf122">复合表达式</h4>
<div class="outline-text-4" id="text-org35cf122">
<ul class="org-ul">
<li>与
<ul class="org-ul">
<li>and</li>
<li>&amp;&amp;</li>
</ul></li>
<li>或
<ul class="org-ul">
<li>or</li>
<li>||</li>
</ul></li>
<li>非
<ul class="org-ul">
<li>not</li>
<li>!</li>
</ul></li>
<li>异或
<ul class="org-ul">
<li>xor</li>
<li>^^</li>
</ul></li>
<li>分片
<ul class="org-ul">
<li>[..]</li>
</ul></li>
</ul>
</div>
</div>

<div id="outline-container-orgc38b9c0" class="outline-4">
<h4 id="orgc38b9c0">过滤值</h4>
<div class="outline-text-4" id="text-orgc38b9c0">
<ul class="org-ul">
<li>应满足过滤项的格式</li>
</ul>

<p>
例子：
</p>
<pre class="example">
eth.src == 04:f9:38:ad:13:26
即筛选源 MAC 是 04:f9:38:ad:13:26 的包

eth.type == 0x00
筛选网络层使用 ip 协议的数据包

ip.src != 192.168.1.1
筛选源地址是 192.168.1.1 之外的数据包

ip.addr = 192.168.1.0/24
筛选出这一网段的数据包

http contains "xxx"
查询 http payload 报文中包含 xxx 字符串的包

http.request.method == GET
筛选 http 包中的 get 请求数据包

ip.src == 192.168.1.1 &amp;&amp; tcp[13]&amp;2
筛选源地址为 192.168.1.1 并且类型为 SYN 的数据包
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-ID-ef271e3d-eb0b-445e-b142-87ce48b892bd" class="outline-2">
<h2 id="ID-ef271e3d-eb0b-445e-b142-87ce48b892bd">捕获过滤器</h2>
<div class="outline-text-2" id="text-ID-ef271e3d-eb0b-445e-b142-87ce48b892bd">
<p>
提前设置好规则，只捕获符合过滤规则的报文。伯克利包捕获表达式： <b>一条基本的表达式由捕获项、捕获参数、捕获值组成</b> ，例如：
</p>
<pre class="example">
捕获项  参数   捕获值
ip  src host 192.168.1.1
协  数据       确定值
议  流向
</pre>
</div>

<div id="outline-container-org22c1693" class="outline-4">
<h4 id="org22c1693">捕获项</h4>
<div class="outline-text-4" id="text-org22c1693">
<ul class="org-ul">
<li>协议</li>
<li>数据流向</li>
</ul>

<p>
协议默认为所有协议，流向默认为 <code>src or dst</code> 。
</p>
</div>
</div>

<div id="outline-container-org1e55ba6" class="outline-4">
<h4 id="org1e55ba6">捕获参数</h4>
<div class="outline-text-4" id="text-org1e55ba6">
<ul class="org-ul">
<li>host (default)</li>
<li>net</li>
<li>port</li>
<li>&#x2026;</li>
</ul>
</div>
</div>

<div id="outline-container-org49faabc" class="outline-4">
<h4 id="org49faabc">捕获值</h4>
<div class="outline-text-4" id="text-org49faabc">
<p>
应满足捕获项的格式
</p>

<p>
例子：
</p>
<pre class="example">
tcp src portrange 0-65535 and tcp dst port 80
捕获源端口为 0-65535 且目的端口为 80 的流量

vlan 10 and ip src net 192.168.1.0/24
捕获 vlan id 为 10 且源网段为 192.168.1.0/24 的所有流量

port 25 and portrange 110-143
捕获电子邮件流量
</pre>
</div>
</div>

<div id="outline-container-org626c75b" class="outline-3">
<h3 id="org626c75b">数据包解析</h3>
<div class="outline-text-3" id="text-org626c75b">
<ul class="org-ul">
<li>Protocol in frame</li>
</ul>
<p>
数据包整体架构，与五层模型相对应
</p>
<ul class="org-ul">
<li>Type</li>
</ul>
<p>
代表网络层应使用何种协议模块来处理
</p>
<ul class="org-ul">
<li>Protocol</li>
</ul>
<p>
代表传输层应使用何种模块来处理
</p>
<ul class="org-ul">
<li>Dst Port</li>
</ul>
<p>
代表应用层应使用的协议及标识连接符
</p>
<ul class="org-ul">
<li>User-Agent</li>
</ul>
<p>
用户标识
</p>
<ul class="org-ul">
<li>Server</li>
</ul>
<p>
中间件类型
</p>

<p>
追踪流 -&gt; http 流
</p>
</div>
</div>

<div id="outline-container-org70ba861" class="outline-3">
<h3 id="org70ba861">捕获远程主机数据包</h3>
<div class="outline-text-3" id="text-org70ba861">
<ul class="org-ul">
<li>需要在被远程捕获的设备上安装 WinPcap，并且该程序运行此应用程序</li>
<li>网络可达，默认 2002 端口</li>
</ul>

<p>
捕获-&gt;选项-&gt;管理接口-&gt;远程接口
</p>

<p>
认证方为 Windows 用户名及密码， <b>必须使用账密登录？</b>
</p>
</div>
</div>
</div>

<div id="outline-container-ID-f74ee637-220d-44c1-8049-32559ba21103" class="outline-2">
<h2 id="ID-f74ee637-220d-44c1-8049-32559ba21103">HTTPS 取证</h2>
<div class="outline-text-2" id="text-ID-f74ee637-220d-44c1-8049-32559ba21103">
<ol class="org-ol">
<li>用服务端的私钥
编辑-&gt;首选项-&gt;Protocol-&gt;TLS-&gt;RSA keys list</li>
<li>用客户端的私钥
通过设置环境变量截取浏览器的 <code>master_secret</code>, 进而实现解密 <a href="20220712-ssl_tls.html#ID-6e2417e2-47b1-4a17-bedc-665791718239">HTTPS</a> 的目的，具体方式（Windows）环境变量中新建用户变量 <code>SSLKEYLOGFILE=C:\path\sslkey.log</code> 文件，之后再 Wireshark 中 <a href="20220712-ssl_tls.html#ID-1265f63a-96d0-4360-b5d4-55440b7ded1a">TLS</a> 配置中制定该文件位置即可</li>
</ol>

<p>
抓到的包可参照 <a href="20220712-ssl_tls.html#ID-c7c9c364-6e46-4a35-a54f-09158c3a12ad">SSL Handshake 阶段交换的信息</a> 进行分析。
</p>
</div>
</div>

<div id="outline-container-ID-fc764106-fe91-4d27-9655-b3daa38fa2e3" class="outline-2">
<h2 id="ID-fc764106-fe91-4d27-9655-b3daa38fa2e3">图片取证</h2>
<div class="outline-text-2" id="text-ID-fc764106-fe91-4d27-9655-b3daa38fa2e3">
<ol class="org-ol">
<li>利用 <code>http contains xxx</code> 定位到请求图片的包</li>
<li>追踪 <a href="20220715-tcp.html#ID-ab245058-bb20-4a0e-b171-fde19a26b2ff">TCP</a>/<a href="20220714-http.html#ID-63e308fa-2fa3-437c-94e8-31ae6a6fc078">HTTP</a> 流</li>
<li>以原始数据 Sava as 为文件</li>
<li>使用文本编辑器去除报文头</li>
<li>改后缀名为图片</li>
</ol>


<figure id="orgf54a674">
<img src="../images/wireshark_jepg_obtain_evidence_1.png" alt="wireshark_jepg_obtain_evidence_1.png">

</figure>

<figure id="orga7b0d68">
<img src="../images/wireshark_jepg_obtain_evidence_2.png" alt="wireshark_jepg_obtain_evidence_2.png">

</figure>
</div>
</div>

<div id="outline-container-ID-11bcbe39-ddf3-4d2f-a460-fee217bb36d3" class="outline-2">
<h2 id="ID-11bcbe39-ddf3-4d2f-a460-fee217bb36d3">AIM 取证</h2>
<div class="outline-text-2" id="text-ID-11bcbe39-ddf3-4d2f-a460-fee217bb36d3">
<p>
类比于聊天软件的取证分析。
</p>

<p>
Wireshark 支持 AIM 解密，右键 -&gt; decode as -&gt; <a href="20220715-tcp.html#ID-ab245058-bb20-4a0e-b171-fde19a26b2ff">TCP</a> port 443 &#x2026; AIM，即可解密 AIM 数据包。
</p>


<figure id="orge09093d">
<img src="../images/wireshark_aim_obtain_evidence_1.png" alt="wireshark_aim_obtain_evidence_1.png">

</figure>
</div>


<div id="outline-container-org4eb18a9" class="outline-4">
<h4 id="org4eb18a9">前置问题</h4>
<div class="outline-text-4" id="text-org4eb18a9">
<ul class="org-ul">
<li>What is the name of Ann&rsquo;s IM buddy?</li>
<li>What was the first comment in the captured IM conversation?</li>
<li>What is the name of the file Ann transferred?</li>
<li>What is the magic number of the file you want to extract(first four bytes)?</li>
<li>What was the MD5sum of the file?</li>
<li>What is the secret recipe?</li>
</ul>
</div>
</div>

<div id="outline-container-org1f8318e" class="outline-4">
<h4 id="org1f8318e">1</h4>
<div class="outline-text-4" id="text-org1f8318e">
<p>
解密 AIM 数据包后，找到协议为 AIM Message 的数据包
</p>

<figure id="org443c1c8">
<img src="../images/wireshark_aim_obtain_evidence_2.png" alt="wireshark_aim_obtain_evidence_2.png">

</figure>

<p>
Buddy 为 Sec558user1
</p>
</div>
</div>

<div id="outline-container-orga82702d" class="outline-4">
<h4 id="orga82702d">2</h4>
<div class="outline-text-4" id="text-orga82702d">
<p>
从 1 中的包中的 Message Block 中可以得到第一条消息的内容，即
</p>
<pre class="example">
ValueMessage: Here's the secret recipe... I just downloaded it from the file server. Just copy to a thumb drive and you're good to go &amp;gt;:-)
</pre>
</div>
</div>

<div id="outline-container-org3df1b65" class="outline-4">
<h4 id="org3df1b65">3</h4>
<div class="outline-text-4" id="text-org3df1b65">
<p>
输入 data 进行筛选，跟踪 <a href="20220715-tcp.html#ID-ab245058-bb20-4a0e-b171-fde19a26b2ff">TCP</a> 流，找到文件名
</p>

<figure id="orgac53768">
<img src="../images/wireshark_aim_obtain_evidence_3.png" alt="wireshark_aim_obtain_evidence_3.png">

</figure>

<p>
文件名为 recipe.docx
</p>
</div>
</div>

<div id="outline-container-orgb3ad87b" class="outline-4">
<h4 id="orgb3ad87b">4</h4>
<div class="outline-text-4" id="text-orgb3ad87b">
<p>
选择 Ann 发送的数据，以原始数据 save as -&gt; recipe.bin
</p>

<figure id="org4fac71b">
<img src="../images/wireshark_aim_obtain_evidence_4.png" alt="wireshark_aim_obtain_evidence_4.png">

</figure>

<figure id="orga28482a">
<img src="../images/wireshark_aim_obtain_evidence_5.png" alt="wireshark_aim_obtain_evidence_5.png">

</figure>

<p>
magic number 为 50 4B 03 04
</p>
</div>
</div>

<div id="outline-container-orgfa5a97c" class="outline-4">
<h4 id="orgfa5a97c">5</h4>
<div class="outline-text-4" id="text-orgfa5a97c">
<p>
计算文件 MD5。
</p>
</div>
</div>

<div id="outline-container-orgba391de" class="outline-4">
<h4 id="orgba391de">6</h4>
<div class="outline-text-4" id="text-orgba391de">
<p>
删除 magic number 之前的数据，另存为 docx 文件即可
</p>

<figure id="org1becbeb">
<img src="../images/wireshark_aim_obtain_evidence_6.png" alt="wireshark_aim_obtain_evidence_6.png">

</figure>
</div>
</div>
</div>


<div id="outline-container-ID-d92036a4-851d-42e7-aec9-5c698f5aa94d" class="outline-2">
<h2 id="ID-d92036a4-851d-42e7-aec9-5c698f5aa94d">邮件取证</h2>
<div class="outline-text-2" id="text-ID-d92036a4-851d-42e7-aec9-5c698f5aa94d">
<p>
以 SMTP 为例子，若要解决用户认证，如果没加密的话可根据 334 状态码可以找到用户名和密码， base64 解码后就可得到用户名和密码
</p>
<pre class="example">
YW5uQGFiYy5kZWY=
YWRtaW4=
</pre>

<p>
base64 解码后得到
</p>
<pre class="example">
ann@abc.def
admin
</pre>


<figure id="orgbc038d5">
<img src="../images/wireshark_email_obtain_evidence_1.png" alt="wireshark_email_obtain_evidence_1.png">

</figure>

<p>
邮件基本信息、正文
</p>

<figure id="org9c5dd30">
<img src="../images/wireshark_email_obtain_evidence_2.png" alt="wireshark_email_obtain_evidence_2.png">

</figure>

<p>
邮件附件
</p>

<figure id="orgaa4ead8">
<img src="../images/wireshark_email_obtain_evidence_3.png" alt="wireshark_email_obtain_evidence_3.png">

</figure>
</div>
</div>

<div id="outline-container-org19c8cd4" class="outline-2">
<h2 id="org19c8cd4">附件</h2>
<div class="outline-text-2" id="text-org19c8cd4">
<p>
<a href="../resources/wireshark_http_with_jepgs.cap">../resources/wireshark_http_with_jepgs.cap</a>
<a href="../resources/wireshark_evidence01.pcap">../resources/wireshark_evidence01.pcap</a>
<a href="../resources/wireshark_email.pcap">../resources/wireshark_email.pcap</a>
</p>
</div>
</div>

<div id="outline-container-ID-6e2b5695-8c56-43db-bc20-6a18802ea836" class="outline-2">
<h2 id="ID-6e2b5695-8c56-43db-bc20-6a18802ea836">tcpdump</h2>
<div class="outline-text-2" id="text-ID-6e2b5695-8c56-43db-bc20-6a18802ea836">
<p>
Linux 系统下的抓包程序，数据包流程： <code>packet -&gt; tcpdump -&gt; iptables -&gt; application -&gt; iptables -&gt; tcpdump -&gt; packet</code> 。
</p>

<div class="org-src-container">
<pre class="src src-bash">tcpdump &lt;option&gt; &lt;proto&gt; &lt;dir&gt; &lt;type&gt;
</pre>
</div>

<p>
常用参数：
</p>
<table>


<colgroup>
<col  class="org-left">

<col  class="org-left">

<col  class="org-left">
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Argument</th>
<th scope="col" class="org-left">&#x00ad;&#x00ad;</th>
<th scope="col" class="org-left">Caption</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">-i [interface]</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">指定网络接口（网卡）</td>
</tr>

<tr>
<td class="org-left">-n</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">不进行主机解析，还可以 <code>-nn, -N</code></td>
</tr>

<tr>
<td class="org-left">-c [cnt]</td>
<td class="org-left"><code>--count</code></td>
<td class="org-left">指定抓取的包数</td>
</tr>

<tr>
<td class="org-left">-w [file.pcap]</td>
<td class="org-left"><code>--write</code></td>
<td class="org-left">将抓到的包写入指定文件</td>
</tr>

<tr>
<td class="org-left">-r [file.pcap]</td>
<td class="org-left"><code>--read</code></td>
<td class="org-left">读取抓包文件</td>
</tr>

<tr>
<td class="org-left">-t</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">时间的显示，还可以 <code>-tt, -ttt, -tttt</code></td>
</tr>

<tr>
<td class="org-left">-v</td>
<td class="org-left"><code>--verbose</code></td>
<td class="org-left">详细输出，还可以 <code>-v, -vv, -vvv</code></td>
</tr>

<tr>
<td class="org-left">-x</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">数据包头部显示为十六进制，还可以 <code>-x, -xx, -X, -XX</code></td>
</tr>

<tr>
<td class="org-left">-Q [in,out,inout]</td>
<td class="org-left"><code>--direction</code></td>
<td class="org-left">指定入方向或出方向或不限</td>
</tr>

<tr>
<td class="org-left">-A</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">以 ASCII 码显示数据包</td>
</tr>

<tr>
<td class="org-left">-l</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">基于行的输出</td>
</tr>

<tr>
<td class="org-left">-q</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">简洁地打印输出</td>
</tr>

<tr>
<td class="org-left">-s [number]</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">指定截取的字节数，为 0 表示截取全部报文</td>
</tr>

<tr>
<td class="org-left">-S</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">使用绝对序列号</td>
</tr>

<tr>
<td class="org-left">-C [file-size]</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">保存到文件中时检查此文件的大小，超过就另建文件</td>
</tr>

<tr>
<td class="org-left">-F [file]</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">使用文件中的内容作为过滤表达式</td>
</tr>

<tr>
<td class="org-left">-D</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">列出可用网络接口</td>
</tr>

<tr>
<td class="org-left">-e</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">每行打印输出将包含数据包的数据链路层头部信息</td>
</tr>

<tr>
<td class="org-left">-E</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">解密 IPsec 数据</td>
</tr>

<tr>
<td class="org-left">-L [interface]</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">列出指定网络接口所支持的数据链路层</td>
</tr>

<tr>
<td class="org-left">-Z [user]</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">抓包时受权限的限制</td>
</tr>

<tr>
<td class="org-left">-d</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">打印易读格式，还可以 <code>-dd, -ddd</code> ，分别为 C ，十进制</td>
</tr>
</tbody>
</table>

<p>
<a href="#ID-ef271e3d-eb0b-445e-b142-87ce48b892bd">捕获过滤器</a>可以抓取符合条件的数据包。
</p>

<p>
还有一些关键字可以使用，如：
</p>
<ul class="org-ul">
<li><code>if</code>: 网络接口名</li>
<li><code>proc</code>: 进程名</li>
<li><code>pid</code>: 进程 pid</li>
<li><code>svc</code>: service class</li>
<li><code>dir</code>: 方向 in, out</li>
<li><code>eproc</code>: effective process name</li>
<li><code>epid</code>: effective process ID</li>
</ul>
</div>
</div>
</div>
<div id="postamble" class="status">
<a href="https://beian.miit.gov.cn" target="_blank">湘ICP证019014083号</a>
</div>
</body>
</html>
