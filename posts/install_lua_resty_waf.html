<!DOCTYPE html>
<html lang="en">
<head>
<!-- 2023-02-02 Thu 21:55 -->
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>安装使用 lua-resty-waf</title>
<meta name="author" content="Honbey Zhang" />
<meta name="generator" content="Org Mode" />

                     <!--
                     <link rel="stylesheet" href="../resources/orgmode.css" type="text/css"/>
                     <link rel="stylesheet" href="../resources/style.css" type="text/css"/>
                     -->
                     <!--
                     <link rel="stylesheet" href="../resources/src/bigblow_theme/css/htmlize.css" type="text/css"/>
                     <link rel="stylesheet" href="../resources/src/bigblow_theme/css/bigblow.css" type="text/css"/>
                     <link rel="stylesheet" href="../resources/src/bigblow_theme/css/hideshow.css" type="text/css"/>
                     <script type="text/javascript" src="../resources/src/bigblow_theme/js/jquery-1.11.0.min.js"></script>
                     <script type="text/javascript" src="../resources/src/bigblow_theme/js/jquery-ui-1.10.2.min.js"></script>
                     <script type="text/javascript" src="../resources/src/bigblow_theme/js/jquery.localscroll-min.js"></script>
                     <script type="text/javascript" src="../resources/src/bigblow_theme/js/jquery.scrollTo-1.4.3.1-min.js"></script>
                     <script type="text/javascript" src="../resources/src/bigblow_theme/js/jquery.zclip.min.js"></script>
                     <script type="text/javascript" src="../resources/src/bigblow_theme/js/bigblow.js"></script>
                     <script type="text/javascript" src="../resources/src/bigblow_theme/js/hideshow.js"></script>
                     <script type="text/javascript" src="../resources/src/lib/js/jquery.stickytableheaders.min.js"></script>
                     -->
                     <link rel="stylesheet" href="../resources/src/readtheorg_theme/css/htmlize.css" type="text/css"/>
                     <link rel="stylesheet" href="../resources/src/readtheorg_theme/css/readtheorg.css" type="text/css"/>
                     <script type="text/javascript" src="../resources/src/lib/js/jquery.min.js"></script>
                     <script type="text/javascript" src="../resources/src/lib/js/bootstrap.min.js"></script>
                     <script type="text/javascript" src="../resources/src/lib/js/jquery.stickytableheaders.min.js"></script>
                     <script type="text/javascript" src="../resources/src/readtheorg_theme/js/readtheorg.js"></script>
</head>
<body>
<div id="content" class="content">
<header>
<h1 class="title">安装使用 lua-resty-waf</h1>
</header><nav id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#orga76beaf">安装 OpenResty</a></li>
<li><a href="#org83e36ce">将 Nginx 迁移到 OpenResty</a></li>
<li><a href="#org25f727d">安装 lua-resty-waf</a></li>
<li><a href="#org81a270c">测试 lua-resty-waf</a>
<ul>
<li><a href="#orga27f8e1">附录</a>
<ul>
<li><a href="#org5118696">nginx.conf</a></li>
<li><a href="#org2903e80">www.conf</a></li>
</ul>
</li>
<li><a href="#org35d3d2a">参考链接</a></li>
</ul>
</li>
</ul>
</div>
</nav>
<p>
系统：CentOS 8.0
域名：<a href="https://freewisdom.cn">https://freewisdom.cn</a>
</p>

<div id="outline-container-orga76beaf" class="outline-2">
<h2 id="orga76beaf">安装 OpenResty</h2>
<div class="outline-text-2" id="text-orga76beaf">
<p>
安装依赖
</p>
<div class="org-src-container">
<pre class="src src-bash">dnf install pcre-devel openssl-devel gcc gcc-c++ curl
</pre>
</div>

<p>
参考官网文档先添加 OpenResty 仓库
</p>
<div class="org-src-container">
<pre class="src src-bash">wget https://openresty.org/package/centos/openresty.repo
mv openresty.repo /etc/yum.repos.d/
</pre>
</div>

<p>
更新软件仓库
</p>
<div class="org-src-container">
<pre class="src src-bash">dnf update
</pre>
</div>

<p>
安装 openresty, openresty-resty, openresty-opm
</p>
<div class="org-src-container">
<pre class="src src-bash">dnf install openresty openresty-resty openresty-opm
</pre>
</div>
</div>
</div>

<div id="outline-container-org83e36ce" class="outline-2">
<h2 id="org83e36ce">将 Nginx 迁移到 OpenResty</h2>
<div class="outline-text-2" id="text-org83e36ce">
<p>
停止 nginx 服务
</p>
<div class="org-src-container">
<pre class="src src-bash">nginx -s stop
</pre>
</div>

<p>
找到 nginx 和 openresty 的配置目录
</p>
<div class="org-src-container">
<pre class="src src-bash">
find / -name nginx.conf -type f

# /etc/nginx/nginx.conf
# /usr/local/openresty/nginx/conf/nginx.conf
</pre>
</div>

<p>
nginx 的配置目录为 <code>/etc/nginx/</code> 及 <code>/etc/nginx/conf.d/</code>
openresty 对应的 nginx 配置目录为 <code>/usr/local/openresty/nginx/conf/</code>
</p>

<p>
复制配置
</p>
<div class="org-src-container">
<pre class="src src-bash">cp /etc/nginx/conf.d/* /usr/local/openresty/nginx/conf/
</pre>
</div>

<p>
然后对照 <code>/etc/nginx/nginx.conf</code> 修改 <code>/usr/local/openresty/nginx/conf/nginx.conf</code>
需要使用 <code>include</code> 将原 <i>etc/nginx/conf.d</i> 下的文件包含进来
</p>

<p>
使用 <code>openresty -t</code> 命令测试配置是否正确，使用 <code>openresty</code> 命令开启 openresty
</p>
</div>
</div>

<div id="outline-container-org25f727d" class="outline-2">
<h2 id="org25f727d">安装 lua-resty-waf</h2>
<div class="outline-text-2" id="text-org25f727d">
<p>
克隆代码
</p>
<div class="org-src-container">
<pre class="src src-bash">git clone https://github.com/p0pr0ck5/lua-resty-waf.git
git submodule init
git submodule update
</pre>
</div>

<p>
直接 <code>make</code> 找不到 ~lua.h~，安装 lua-devel
</p>
<pre class="example">
dnf install lua luarocks
dnf install http://mirror.centos.org/centos/8/PowerTools/x86_64/os/Packages/lua-devel-5.3.4-11.el8.x86_64.rpm
</pre>
<p>
修改 lua 版本，这样会导致后面 rex<sub>pcre.so</sub> 启动不起来，还是需要强制安装 lua 5.1
修改 <code>lua-aho-corasick/Makefile</code> 以及 <code>lua-resty-htmlentities/Makefile</code>
</p>

<div class="org-src-container">
<pre class="src src-bash">sed -i 's/LUA_VERSION = 5.1/LUA_VERSION = 5.3/' \
lua-aho-corasick/Makefile \
lua-resty-htmlentities/Makefile
</pre>
</div>

<p>
Centos 8 强制安装 lua-5.1, lua-devel-5.1, luarocks
</p>
<div class="org-src-container">
<pre class="src src-bash">wget http://mirror.centos.org/centos/7/os/x86_64/Packages/lua-5.1.4-15.el7.x86_64.rpm
rpm -i ./lua-5.1.4-15.el7.x86_64.rpm --nodeps
dnf install http://mirror.centos.org/centos/7/os/x86_64/Packages/lua-devel-5.1.4-15.el7.x86_64.rpm
dnf install https://download-ib01.fedoraproject.org/pub/epel/7/x86_64/Packages/l/luarocks-2.3.0-1.el7.x86_64.rpm
</pre>
</div>

<p>
要使得 lua 5.1 正常运行，需要链接一些资源文件
</p>
<div class="org-src-container">
<pre class="src src-bash"># find / -name libreadline.so
cd /usr/lib64
ln -s libreadline.so.7.0 libreadline.so.6
ln -s libncurses.so.6.1 libncurses.so.5
ln -s libtinfo.so.6.1 libtinfo.so.5
</pre>
</div>

<p>
测试 lua 能否正常运行
</p>
<div class="org-src-container">
<pre class="src src-bash">lua -v
# Lua 5.1.4  Copyright (C) 1994-2008 Lua.org, PUC-Rio
lua
# Lua 5.1.4  Copyright (C) 1994-2008 Lua.org, PUC-Rio
# &gt;
</pre>
</div>

<p>
Centos 8 默认没有 <code>python</code> 命令，可修改 .py 文件的 <code>python</code> 为 <code>python2</code>
</p>
<div class="org-src-container">
<pre class="src src-bash">set -i 's/#!\/usr\/bin\/env python/#!\/usr\/bin\/env python2/' \
libinjection/src/fingerprints2sqli.py \
libinjection/src/make_parens.py \
libinjection/src/sqlparse2c.py \
libinjection/src/sqlparse_map.py
</pre>
</div>

<p>
<code>make</code> 以及 <code>make install</code>
</p>

<p>
编译完成后重启 openresty
</p>
<div class="org-src-container">
<pre class="src src-bash"># openresty -s reload
openresty -s stop
openresty
</pre>
</div>
</div>
</div>



<div id="outline-container-org81a270c" class="outline-2">
<h2 id="org81a270c">测试 lua-resty-waf</h2>
<div class="outline-text-2" id="text-org81a270c">
<p>
测试网址：
</p>
<pre class="example">
https://freewisdom.cn/
https://xampp.freewisdom.cn/
</pre>

<p>
访问 <code>https://freewisdom.cn/?id=&lt;script&gt;alert(123)&lt;/script&gt;, https://freewisdom.cn/?id=1'or'1=1</code> 均返回 403，服务器日志如下：
</p>
<div class="org-src-container">
<pre class="src src-json">{
  "timestamp": 1614936394,
  "client": "107.150.120.83",
  "method": "GET",
  "uri": "/",
  "id": "e62f6b10a7f0a593de01",
  "alerts": [
    {
      "msg": "SQL Tautologies",
      "id": 41005,
      "match": 2
    },
    {
      "msg": "SQL Injection character anomaly - ARGS",
      "id": 41015,
      "match": 1
    },
    {
      "msg": "XSS (Cross-Site Scripting)",
      "id": 42043,
      "match": 9
    },
    {
      "msg": "XSS (Cross-Site Scripting)",
      "id": 42059,
      "match": 1
    },
    {
      "msg": "XSS (Cross-Site Scripting) - HTML Tag Handler",
      "id": 42069,
      "match": 1
    },
    {
      "msg": "XSS (Cross-Site Scripting) - JS Fragments",
      "id": 42076,
      "match": 9
    },
    {
      "msg": "XSS (Cross-Site Scripting) - IE Filter",
      "id": 42083,
      "match": 1
    },
    {
      "msg": "Request score greater than score threshold",
      "logdata": 28,
      "id": 99001,
      "match": 28
    }
  ],
  "uri_args": {
    "id": "&lt;script&gt;alert(123)&lt;/script&gt;"
  }
}
</pre>
</div>
</div>


<div id="outline-container-orga27f8e1" class="outline-3">
<h3 id="orga27f8e1">附录</h3>
<div class="outline-text-3" id="text-orga27f8e1">
</div>
<div id="outline-container-org5118696" class="outline-4">
<h4 id="org5118696">nginx.conf</h4>
<div class="outline-text-4" id="text-org5118696">
<div class="org-src-container">
<pre class="src src-nginx">#user  nobody;
worker_processes  1;

#error_log  logs/error.log;
#pid        logs/nginx.pid;

events {
    worker_connections  1024;
}

http {
    include       mime.types;
    default_type  application/octet-stream;

    #log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
    #                  '$status $body_bytes_sent "$http_referer" '
    #                  '"$http_user_agent" "$http_x_forwarded_for"';

    #access_log  logs/access.log  main;

    sendfile        on;
    #tcp_nopush     on;
    #tcp_nodelay    on;

    #keepalive_timeout  0;
    keepalive_timeout  65;

    # Avoid Attack
    server_tokens off;

      # WAF
    init_by_lua_block {
        -- use resty.core for performance improvement, see the status note above
        require "resty.core"

        -- require the base module
        local lua_resty_waf = require "resty.waf"

        -- perform some preloading and optimization
        lua_resty_waf.init()
    }

    gzip on;

    include allHTTPS.conf;
    # WAF
    include xampp.conf;
    include www.conf;

    server {
        listen       80 default_server;
        server_name  _;

        #charset koi8-r;

        #access_log  logs/host.access.log  main;

        rewrite      ^(.*) https://freewisdom.cn;

        location / {
            #root   html;
            #index  index.html index.htm;
        }

        #error_page  404              /404.html;

        # redirect server error pages to the static page /50x.html
        #
        error_page   500 502 503 504  /50x.html;
        location = /50x.html {
            root   html;
        }
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org2903e80" class="outline-4">
<h4 id="org2903e80">www.conf</h4>
<div class="outline-text-4" id="text-org2903e80">
<div class="org-src-container">
<pre class="src src-bash">    server {
        listen       443;
        server_name  freewisdom.cn;
        root         /var/web/public;
        index        index.html index.htm;
        #error_log logs/www.error.log;

        location / {
            #expires 7d;
            access_by_lua_block {
                local lua_resty_waf = require "resty.waf"

                local waf = lua_resty_waf:new()

                -- define options that will be inherited across all scopes
                waf:set_option("debug", true)
                waf:set_option("mode", "ACTIVE")

                waf:set_option("event_log_target", "file")
                waf:set_option("event_log_target_path", "/tmp/event.log")

                waf:set_option("debug_log_level", ngx.DEBUG)
                waf:set_option("event_log_altered_only", false)
                waf:set_option("event_log_request_arguments", true)
                waf:set_option("event_log_request_body", true)
                waf:set_option("event_log_verbosity", 4)

                waf:set_option("event_log_periodic_flush", 30)
                waf:set_option("event_log_buffer_size", 128)

                -- this may be desirable for low-traffic or testing sites
                -- by default, event logs are not written until the buffer is full
                -- for testing, flush the log buffer every 5 seconds
                --
                -- this is only necessary when configuring a remote TCP/UDP
                -- socket server for event logs. otherwise, this is ignored
                -- waf:set_option("event_log_periodic_flush", 5)

                -- run the firewall
                waf:exec()
            }

            header_filter_by_lua_block {
                local lua_resty_waf = require "resty.waf"

                -- note that options set in previous handlers (in the same scope)
                -- do not need to be set again
                local waf = lua_resty_waf:new()

                waf:exec()
            }

            body_filter_by_lua_block {
                local lua_resty_waf = require "resty.waf"

                local waf = lua_resty_waf:new()

                waf:exec()
            }

            log_by_lua_block {
                local lua_resty_waf = require "resty.waf"

                local waf = lua_resty_waf:new()

                -- waf:exec()
                waf:write_log_events()
            }
        }

        location ~ .*\.(php?|cgi|pl|py)$ {
            deny all;
        }

        location ~ /\.ht {
            deny all;
        }

        location ~ /.+\.(inc|conf|cnf) {
            deny all;
        }

        #fastcgi_intercept_errors on;

        error_page 404 /404.html;
            location = /404.html {
            root /var/web/public;
        }
    }
</pre>
</div>
</div>
</div>
</div>



<div id="outline-container-org35d3d2a" class="outline-3">
<h3 id="org35d3d2a">参考链接</h3>
<div class="outline-text-3" id="text-org35d3d2a">
<ol class="org-ol">
<li><a href="http://openresty.org/cn/">OpenResty 中文文档</a></li>
<li><a href="https://github.com/p0pr0ck5/lua-resty-waf">p0pr0ck5/lua-resty-waf</a></li>
<li><a href="https://www.cnblogs.com/xxpal/articles/816692.html">rpm 命令参数详解</a></li>
</ol>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">

                     Theme
                     <a href="https://github.com/fniessen/org-html-themes" target="_blank">bigblow/readtheorg</a>
                     by
                     <a href="https://github.com/fniessen" target="_blank">fniessen</a>
                     <br>
                     <a href="https://beian.miit.gov.cn" target="_blank">湘ICP证019014083号</a>
</div>
</body>
</html>